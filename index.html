<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Headache Tracker - Version 3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .version-badge {
            display: inline-block;
            background: #764ba2;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 3px solid #eee;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 15px 25px;
            background: #f0f0f0;
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: #e0e0e0;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .date-display {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.3em;
            color: #555;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .section-title {
            font-size: 1.4em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-number {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .insight-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #4facfe;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .insight-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .insight-text {
            font-size: 1.1em;
            color: #333;
            line-height: 1.6;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            border: 2px solid #eee;
        }

        .calendar-day.no-data {
            background: #f5f5f5;
            color: #999;
        }

        .calendar-day.no-headache {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .calendar-day.headache-low {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .calendar-day.headache-medium {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .calendar-day.headache-high {
            background: #f5c6cb;
            color: #721c24;
            border-color: #f1b0b7;
        }

        .calendar-header {
            font-weight: 700;
            color: #667eea;
            padding: 10px;
            text-align: center;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .encouragement-banner {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5em;
            font-weight: 700;
        }

        .report-button {
            width: 100%;
            padding: 20px;
            font-size: 1.3em;
            font-weight: 700;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .report-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .question {
            margin-bottom: 25px;
        }

        .question-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .big-button {
            flex: 1;
            min-width: 120px;
            padding: 20px;
            font-size: 1.3em;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }

        .big-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .big-button.selected {
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.9), 0 0 20px rgba(0, 0, 0, 0.3);
            transform: scale(1.1);
            font-weight: 900;
            border: 3px solid white;
        }

        .yes-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .no-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .option-button {
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
        }

        .option-button:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .option-button.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
            font-weight: 700;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .emoji-scale {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .emoji-option {
            padding: 15px;
            text-align: center;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .emoji-option:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .emoji-option.selected {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .emoji-option .emoji {
            font-size: 2em;
            display: block;
            margin-bottom: 5px;
        }

        .emoji-option .label {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 1em;
            color: #333;
        }

        .water-cups {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .water-option {
            padding: 15px 25px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1em;
        }

        .water-option:hover {
            border-color: #4facfe;
        }

        .water-option.selected {
            border-color: #4facfe;
            background: #4facfe;
            color: white;
            font-weight: 700;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        .submit-button {
            width: 100%;
            padding: 20px;
            font-size: 1.5em;
            font-weight: 700;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .submit-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .submit-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .confirmation {
            display: none;
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .confirmation.show {
            display: block;
        }

        .confirmation h2 {
            color: white;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .confirmation p {
            color: white;
            font-size: 1.3em;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .history-card.intensity-low {
            border-left-color: #84fab0;
            background: #f0fff4;
        }

        .history-card.intensity-medium {
            border-left-color: #ffd93d;
            background: #fffef0;
        }

        .history-card.intensity-high {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .history-card.no-headache {
            border-left-color: #4facfe;
            background: #f0f9ff;
        }

        .history-date {
            font-weight: 700;
            color: #333;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .history-details {
            color: #666;
            font-size: 1em;
            line-height: 1.6;
        }

        .history-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .history-label {
            font-weight: 600;
            color: #667eea;
            margin-right: 5px;
        }

        .no-entries {
            text-align: center;
            color: #999;
            font-size: 1.2em;
            padding: 20px;
        }

        .reset-button {
            margin-top: 20px;
            padding: 12px 25px;
            background: #f5576c;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
        }

        .reset-button:hover {
            background: #d43f52;
        }

        .hidden {
            display: none;
        }

        .user-select-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .user-select-card {
            background: white;
            border-radius: 20px;
            padding: 50px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .user-select-card h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .user-select-card p {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .user-button {
            padding: 20px;
            font-size: 1.3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .add-user-button {
            padding: 15px;
            font-size: 1.1em;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .add-user-button:hover {
            background: #f0f0ff;
        }

        .current-user-banner {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .switch-user-button {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }

        .switch-user-button:hover {
            background: #f0f0ff;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            .nav-tabs, .reset-button, .report-button {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="userSelectScreen" class="user-select-screen">
        <div class="user-select-card">
            <h2>👤 Who's tracking today?</h2>
            <p>Select your name to continue</p>
            <div class="user-list" id="userList"></div>
            <button class="add-user-button" onclick="addNewUser()">➕ Add New Person</button>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="current-user-banner">
            <span>📊 Tracking for: <strong id="currentUserName"></strong></span>
            <button class="switch-user-button" onclick="switchUser()">Switch User</button>
        </div>

        <div class="header">
            <h1>🧠 Daily Headache Tracker</h1>
            <span class="version-badge">Version 3 - Analytics</span>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="switchTab('log')">📝 Daily Tracker</button>
            <button class="nav-tab" onclick="switchTab('history')">📅 History</button>
        </div>

        <div id="dashboardTab" class="tab-content active">
            <div id="encouragementBanner" class="encouragement-banner"></div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalHeadaches">0</div>
                    <div class="stat-label">Headaches This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="headacheFree">0</div>
                    <div class="stat-label">Headache-Free Days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgIntensity">0</div>
                    <div class="stat-label">Average Intensity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="streakDays">0</div>
                    <div class="stat-label">Days Since Last Headache</div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">📅 This Month's Calendar</div>
                <div id="calendarView"></div>
            </div>

            <div class="section">
                <div class="section-title">💡 Insights & Patterns</div>
                <div id="insightsContainer"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">📈 Headaches by Day of Week</div>
                <canvas id="dayOfWeekChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">🔍 Trigger Analysis</div>
                <canvas id="triggerChart"></canvas>
            </div>

            <button class="report-button" onclick="generateDoctorReport()">🏥 Generate Doctor Report</button>
        </div>

        <div id="logTab" class="tab-content">
            <div class="date-display" id="dateDisplay"></div>

            <div class="section">
                <div class="question">
                    <div class="question-text">Did you have a headache today?</div>
                    <div class="button-group">
                        <button class="big-button yes-button" onclick="handleHeadacheResponse(true)">YES</button>
                        <button class="big-button no-button" onclick="handleHeadacheResponse(false)">NO</button>
                    </div>
                </div>
            </div>

            <div id="headacheDetails" class="hidden">
                <div class="section">
                    <div class="section-title">📍 Tell us about your headache</div>
                    
                    <div class="question">
                        <div class="question-text">When did it start?</div>
                        <div class="button-group">
                            <button class="option-button" onclick="toggleSelection(this, 'startTime')">🌅 Morning</button>
                            <button class="option-button" onclick="toggleSelection(this, 'startTime')">☀️ Afternoon</button>
                            <button class="option-button" onclick="toggleSelection(this, 'startTime')">🌆 Evening</button>
                            <button class="option-button" onclick="toggleSelection(this, 'startTime')">🌙 Night</button>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-text">How bad was it?</div>
                        <div class="emoji-scale">
                            <div class="emoji-option" data-value="1-3" onclick="selectIntensity(this)">
                                <span class="emoji">😊</span>
                                <span class="label">1-3</span>
                            </div>
                            <div class="emoji-option" data-value="4-6" onclick="selectIntensity(this)">
                                <span class="emoji">😐</span>
                                <span class="label">4-6</span>
                            </div>
                            <div class="emoji-option" data-value="7-9" onclick="selectIntensity(this)">
                                <span class="emoji">😢</span>
                                <span class="label">7-9</span>
                            </div>
                            <div class="emoji-option" data-value="10" onclick="selectIntensity(this)">
                                <span class="emoji">😫</span>
                                <span class="label">10</span>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-text">Where did your head hurt?</div>
                        <div class="button-group">
                            <button class="option-button" onclick="toggleSelection(this, 'location')">Front</button>
                            <button class="option-button" onclick="toggleSelection(this, 'location')">Back</button>
                            <button class="option-button" onclick="toggleSelection(this, 'location')">Sides</button>
                            <button class="option-button" onclick="toggleSelection(this, 'location')">Temples</button>
                            <button class="option-button" onclick="toggleSelection(this, 'location')">All Over</button>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-text">How long did it last?</div>
                        <div class="button-group">
                            <button class="option-button" onclick="toggleSelection(this, 'duration')">⏱️ Less than 1 hour</button>
                            <button class="option-button" onclick="toggleSelection(this, 'duration')">⏰ 1-2 hours</button>
                            <button class="option-button" onclick="toggleSelection(this, 'duration')">⏳ 2-4 hours</button>
                            <button class="option-button" onclick="toggleSelection(this, 'duration')">🕐 More than 4 hours</button>
                            <button class="option-button" onclick="toggleSelection(this, 'duration')">😣 Still hurts</button>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-text">Did you have any of these?</div>
                        <div class="checkbox-group" id="symptoms">
                            <div class="checkbox-item">
                                <input type="checkbox" id="symptom1" value="Felt sick to stomach">
                                <label for="symptom1">Felt sick to stomach</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="symptom2" value="Bright lights hurt my eyes">
                                <label for="symptom2">Bright lights hurt my eyes</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="symptom3" value="Sounds were too loud">
                                <label for="symptom3">Sounds were too loud</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="symptom4" value="Felt dizzy">
                                <label for="symptom4">Felt dizzy</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="symptom5" value="Vision was blurry or weird">
                                <label for="symptom5">Vision was blurry or weird</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">📝 Daily Check-in</div>

                <div class="question">
                    <div class="question-text">What was the weather today?</div>
                    <div class="button-group">
                        <button class="option-button" onclick="toggleSelection(this, 'weather')">☀️ Sunny</button>
                        <button class="option-button" onclick="toggleSelection(this, 'weather')">🌧️ Rainy</button>
                        <button class="option-button" onclick="toggleSelection(this, 'weather')">☁️ Cloudy</button>
                        <button class="option-button" onclick="toggleSelection(this, 'weather')">🔥 Hot</button>
                        <button class="option-button" onclick="toggleSelection(this, 'weather')">❄️ Cold</button>
                    </div>
                </div>

                <div class="question">
                    <div class="question-text">How did you feel today? (You can pick more than one!)</div>
                    <div class="button-group">
                        <button class="option-button" onclick="toggleSelection(this, 'mood')">😊 Happy</button>
                        <button class="option-button" onclick="toggleSelection(this, 'mood')">😰 Worried/Stressed</button>
                        <button class="option-button" onclick="toggleSelection(this, 'mood')">😴 Tired</button>
                        <button class="option-button" onclick="toggleSelection(this, 'mood')">😠 Angry</button>
                        <button class="option-button" onclick="toggleSelection(this, 'mood')">😢 Sad</button>
                        <button class="option-button" onclick="toggleSelection(this, 'mood')">😐 Normal</button>
                    </div>
                </div>

                <div class="question">
                    <div class="question-text">Did you exercise or play hard today?</div>
                    <div class="button-group">
                        <button class="big-button yes-button" onclick="handleExerciseResponse(this, 'YES')">YES</button>
                        <button class="big-button no-button" onclick="handleExerciseResponse(this, 'NO')">NO</button>
                    </div>
                </div>

                <div class="question">
                    <div class="question-text">Did you drink enough water?</div>
                    <div class="water-cups">
                        <div class="water-option" onclick="toggleSelection(this, 'water')">💧 Yes</div>
                        <div class="water-option" onclick="toggleSelection(this, 'water')">🤔 Not sure</div>
                        <div class="water-option" onclick="toggleSelection(this, 'water')">❌ No</div>
                    </div>
                </div>

                <div class="question">
                    <div class="question-text">Did you eat your meals today?</div>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="meal1" value="Breakfast">
                            <label for="meal1">🍳 Breakfast</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="meal2" value="Lunch">
                            <label for="meal2">🥪 Lunch</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="meal3" value="Dinner">
                            <label for="meal3">🍽️ Dinner</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="meal4" value="Snacks">
                            <label for="meal4">🍎 Snacks</label>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <div class="question-text">How much screen time did you have?</div>
                    <div class="button-group">
                        <button class="option-button" onclick="toggleSelection(this, 'screen')">📱 A little</button>
                        <button class="option-button" onclick="toggleSelection(this, 'screen')">📱📱 Some</button>
                        <button class="option-button" onclick="toggleSelection(this, 'screen')">📱📱📱 A lot</button>
                    </div>
                </div>

                <div class="question">
                    <div class="question-text">How did you sleep last night?</div>
                    <div class="button-group">
                        <button class="option-button" onclick="toggleSelection(this, 'sleep')">⭐ Great</button>
                        <button class="option-button" onclick="toggleSelection(this, 'sleep')">👍 OK</button>
                        <button class="option-button" onclick="toggleSelection(this, 'sleep')">😴 Not good</button>
                    </div>
                </div>
            </div>

            <button class="submit-button" id="submitButton" onclick="submitEntry()" disabled>Submit Entry</button>

            <div class="confirmation" id="confirmation">
                <h2>🎉 Awesome job!</h2>
                <p id="confirmationText"></p>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="section">
                <div class="section-title">📅 All Entries</div>
                <div class="history-list" id="historyList">
                    <div class="no-entries">No entries yet. Start tracking today!</div>
                </div>
                <button class="reset-button" onclick="addNewEntry()">Add Another Entry</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentEntry = {
            hasHeadache: null,
            startTime: null,
            intensity: null,
            location: [],
            duration: null,
            symptoms: [],
            weather: null,
            mood: [],
            exercise: null,
            water: null,
            meals: [],
            screen: null,
            sleep: null
        };

        let dayOfWeekChart = null;
        let triggerChart = null;

        function getUsers() {
            const users = localStorage.getItem('headacheTrackerUsers');
            return users ? JSON.parse(users) : [];
        }

        function saveUsers(users) {
            localStorage.setItem('headacheTrackerUsers', JSON.stringify(users));
        }

        function displayUserList() {
            const users = getUsers();
            const userList = document.getElementById('userList');
            
            if (!userList) return;
            
            if (users.length === 0) {
                userList.innerHTML = '<p style="color: #666; font-size: 1.1em;">No users yet. Click "Add New Person" to get started!</p>';
            } else {
                userList.innerHTML = users.map(user => 
                    `<button class="user-button" onclick="selectUser('${user}')">${user}</button>`
                ).join('');
            }
        }

        function addNewUser() {
            const name = prompt('Enter a name for the new person:');
            if (!name || name.trim() === '') return;
            
            const users = getUsers();
            const trimmedName = name.trim();
            
            if (users.includes(trimmedName)) {
                alert('This name already exists. Please choose a different name.');
                return;
            }
            
            users.push(trimmedName);
            saveUsers(users);
            selectUser(trimmedName);
        }

        function selectUser(userName) {
            currentUser = userName;
            localStorage.setItem('currentHeadacheUser', userName);
            
            const currentUserNameEl = document.getElementById('currentUserName');
            if (currentUserNameEl) currentUserNameEl.textContent = userName;
            
            document.getElementById('userSelectScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            initializeEventListeners();
            updateDashboard();
            displayHistory();
        }

        function switchUser() {
            currentUser = null;
            localStorage.removeItem('currentHeadacheUser');
            document.getElementById('userSelectScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            displayUserList();
            resetForm();
        }

        function getUserStorageKey() {
            return `headacheEntriesV3_${currentUser}`;
        }

        function checkForCurrentUser() {
            const savedUser = localStorage.getItem('currentHeadacheUser');
            const users = getUsers();
            
            if (savedUser && users.includes(savedUser)) {
                selectUser(savedUser);
            } else {
                document.getElementById('userSelectScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                displayUserList();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            if (tabName === 'dashboard') {
                document.getElementById('dashboardTab').classList.add('active');
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
                updateDashboard();
            } else if (tabName === 'log') {
                document.getElementById('logTab').classList.add('active');
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
            } else if (tabName === 'history') {
                document.getElementById('historyTab').classList.add('active');
                document.querySelectorAll('.nav-tab')[2].classList.add('active');
                displayHistory();
            }
        }

        function displayCurrentDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateEl = document.getElementById('dateDisplay');
            if (dateEl) dateEl.textContent = today.toLocaleDateString('en-US', options);
        }

        function handleHeadacheResponse(hasHeadache) {
            currentEntry.hasHeadache = hasHeadache;
            const headacheDetails = document.getElementById('headacheDetails');
            const yesButtons = document.querySelectorAll('.yes-button');
            const noButtons = document.querySelectorAll('.no-button');
            
            yesButtons.forEach(btn => btn.classList.remove('selected'));
            noButtons.forEach(btn => btn.classList.remove('selected'));
            
            if (hasHeadache) {
                yesButtons[0].classList.add('selected');
                headacheDetails.classList.remove('hidden');
            } else {
                noButtons[0].classList.add('selected');
                headacheDetails.classList.add('hidden');
                currentEntry.startTime = null;
                currentEntry.intensity = null;
                currentEntry.location = [];
                currentEntry.duration = null;
                currentEntry.symptoms = [];
                
                setTimeout(() => {
                    const dailySection = document.querySelector('#logTab .section:last-of-type');
                    if (dailySection) dailySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
            
            checkFormComplete();
        }

        function handleExerciseResponse(element, value) {
            const exerciseButtons = element.parentElement.querySelectorAll('.big-button');
            exerciseButtons.forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            currentEntry.exercise = value;
            checkFormComplete();
        }

        function toggleSelection(element, category) {
            if (category === 'location' || category === 'mood') {
                element.classList.toggle('selected');
                const value = element.textContent.trim();
                const index = currentEntry[category].indexOf(value);
                if (index > -1) {
                    currentEntry[category].splice(index, 1);
                } else {
                    currentEntry[category].push(value);
                }
            } else if (category === 'startTime' || category === 'duration') {
                const siblings = element.parentElement.querySelectorAll('.option-button');
                siblings.forEach(sib => sib.classList.remove('selected'));
                element.classList.add('selected');
                const text = element.textContent.trim();
                const cleanText = text.substring(text.indexOf(' ') + 1);
                currentEntry[category] = cleanText;
            } else {
                const siblings = element.parentElement.querySelectorAll('.option-button, .water-option');
                siblings.forEach(sib => sib.classList.remove('selected'));
                element.classList.add('selected');
                currentEntry[category] = element.textContent.trim();
            }
            checkFormComplete();
        }

        function selectIntensity(element) {
            document.querySelectorAll('.emoji-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            currentEntry.intensity = element.getAttribute('data-value');
            checkFormComplete();
        }

        function checkFormComplete() {
            const submitButton = document.getElementById('submitButton');
            if (!submitButton) return;
            
            let isComplete = currentEntry.hasHeadache !== null &&
                           currentEntry.weather !== null &&
                           currentEntry.mood.length > 0 &&
                           currentEntry.exercise !== null &&
                           currentEntry.water !== null &&
                           currentEntry.screen !== null &&
                           currentEntry.sleep !== null;

            if (currentEntry.hasHeadache) {
                isComplete = isComplete && 
                           currentEntry.startTime !== null &&
                           currentEntry.intensity !== null &&
                           currentEntry.location.length > 0 &&
                           currentEntry.duration !== null;
            }

            submitButton.disabled = !isComplete;
        }

        function initializeEventListeners() {
            setTimeout(function() {
                const symptomsCheckboxes = document.querySelectorAll('#symptoms input[type="checkbox"]');
                symptomsCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        currentEntry.symptoms = Array.from(document.querySelectorAll('#symptoms input:checked'))
                            .map(cb => cb.value);
                    });
                });

                const mealCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="meal"]');
                mealCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        currentEntry.meals = Array.from(document.querySelectorAll('input[type="checkbox"][id^="meal"]:checked'))
                            .map(cb => cb.value);
                        checkFormComplete();
                    });
                });
            }, 100);
        }

        function submitEntry() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            currentEntry.meals = Array.from(document.querySelectorAll('input[type="checkbox"][id^="meal"]:checked'))
                .map(cb => cb.value);
            
            const entry = { date: dateStr, ...currentEntry };
            let entries = JSON.parse(localStorage.getItem(getUserStorageKey()) || '[]');
            
            const existingIndex = entries.findIndex(e => e.date === dateStr);
            if (existingIndex !== -1) {
                entries[existingIndex] = entry;
            } else {
                entries.push(entry);
            }
            
            localStorage.setItem(getUserStorageKey(), JSON.stringify(entries));

            const confirmation = document.getElementById('confirmation');
            const confirmationText = document.getElementById('confirmationText');
            confirmationText.textContent = `Entry saved for ${today.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}! Great work tracking your health!`;
            confirmation.classList.add('show');

            document.querySelectorAll('button').forEach(btn => {
                if (!btn.classList.contains('reset-button') && !btn.classList.contains('nav-tab') && 
                    !btn.classList.contains('report-button') && !btn.classList.contains('switch-user-button')) {
                    btn.disabled = true;
                }
            });

            setTimeout(() => {
                switchTab('dashboard');
                resetForm();
            }, 2000);
        }

        function displayHistory() {
            const entries = JSON.parse(localStorage.getItem(getUserStorageKey()) || '[]');
            const historyList = document.getElementById('historyList');
            if (!historyList) return;

            if (entries.length === 0) {
                historyList.innerHTML = '<div class="no-entries">No entries yet. Start tracking today!</div>';
                return;
            }

            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            historyList.innerHTML = entries.map(entry => {
                const [year, month, day] = entry.date.split('-');
                const date = new Date(year, month - 1, day);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });

                let intensityClass = 'no-headache';
                if (entry.hasHeadache) {
                    if (entry.intensity === '1-3') intensityClass = 'intensity-low';
                    else if (entry.intensity === '4-6') intensityClass = 'intensity-medium';
                    else intensityClass = 'intensity-high';
                }

                let html = `<div class="history-card ${intensityClass}">
                    <div class="history-date">${formattedDate}</div>
                    <div class="history-details">`;

                if (entry.hasHeadache) {
                    html += `
                        <div><strong>⚠️ Headache</strong></div>
                        <div><span class="history-label">Started:</span>${entry.startTime}</div>
                        <div><span class="history-label">Intensity:</span>${entry.intensity}/10</div>
                        <div><span class="history-label">Location:</span>${entry.location.join(', ')}</div>
                        <div><span class="history-label">Duration:</span>${entry.duration}</div>`;
                    
                    if (entry.symptoms && entry.symptoms.length > 0) {
                        html += `<div><span class="history-label">Symptoms:</span>${entry.symptoms.join(', ')}</div>`;
                    }
                } else {
                    html += `<div><strong>✅ No headache today!</strong></div>`;
                }

                html += `
                    <div class="history-section">
                        <div><span class="history-label">Weather:</span>${entry.weather}</div>
                        <div><span class="history-label">Mood:</span>${Array.isArray(entry.mood) ? entry.mood.join(', ') : entry.mood}</div>
                        <div><span class="history-label">Exercise:</span>${entry.exercise}</div>
                        <div><span class="history-label">Water:</span>${entry.water}</div>
                        <div><span class="history-label">Meals:</span>${entry.meals && entry.meals.length > 0 ? entry.meals.join(', ') : 'None'}</div>
                        <div><span class="history-label">Screen time:</span>${entry.screen}</div>
                        <div><span class="history-label">Sleep:</span>${entry.sleep}</div>
                    </div>
                </div></div>`;

                return html;
            }).join('');
        }

        function addNewEntry() {
            resetForm();
            switchTab('log');
        }

        function resetForm() {
            currentEntry = {
                hasHeadache: null,
                startTime: null,
                intensity: null,
                location: [],
                duration: null,
                symptoms: [],
                weather: null,
                mood: [],
                exercise: null,
                water: null,
                meals: [],
                screen: null,
                sleep: null
            };

            const headacheDetails = document.getElementById('headacheDetails');
            const confirmation = document.getElementById('confirmation');
            const submitButton = document.getElementById('submitButton');
            
            if (headacheDetails) headacheDetails.classList.add('hidden');
            if (confirmation) confirmation.classList.remove('show');
            
            document.querySelectorAll('.emoji-option, .option-button, .big-button, .water-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('button').forEach(btn => btn.disabled = false);
            
            if (submitButton) submitButton.disabled = true;
            displayCurrentDate();
        }

        function updateDashboard() {
            const entries = JSON.parse(localStorage.getItem(getUserStorageKey()) || '[]');
            
            if (entries.length === 0) {
                const banner = document.getElementById('encouragementBanner');
                if (banner) banner.textContent = "Start tracking to see your patterns! 🌟";
                return;
            }

            const today = new Date();
            const thisMonth = entries.filter(e => {
                const [year, month] = e.date.split('-');
                return parseInt(month) === today.getMonth() + 1 && parseInt(year) === today.getFullYear();
            });

            const headacheDays = thisMonth.filter(e => e.hasHeadache).length;
            const headacheFreeDays = thisMonth.filter(e => !e.hasHeadache).length;

            const headacheEntries = thisMonth.filter(e => e.hasHeadache);
            let totalIntensity = 0;
            headacheEntries.forEach(e => {
                if (e.intensity === '1-3') totalIntensity += 2;
                else if (e.intensity === '4-6') totalIntensity += 5;
                else if (e.intensity === '7-9') totalIntensity += 8;
                else if (e.intensity === '10') totalIntensity += 10;
            });
            const avgIntensity = headacheEntries.length > 0 ? (totalIntensity / headacheEntries.length).toFixed(1) : 0;

            entries.sort((a, b) => new Date(b.date) - new Date(a.date));
            let streakDays = 0;
            for (let entry of entries) {
                if (entry.hasHeadache) break;
                streakDays++;
            }

            const totalHeadachesEl = document.getElementById('totalHeadaches');
            const headacheFreeEl = document.getElementById('headacheFree');
            const avgIntensityEl = document.getElementById('avgIntensity');
            const streakDaysEl = document.getElementById('streakDays');
            
            if (totalHeadachesEl) totalHeadachesEl.textContent = headacheDays;
            if (headacheFreeEl) headacheFreeEl.textContent = headacheFreeDays;
            if (avgIntensityEl) avgIntensityEl.textContent = avgIntensity;
            if (streakDaysEl) streakDaysEl.textContent = streakDays;

            let encouragement = "";
            if (streakDays === 0) encouragement = "Keep tracking! You're learning about your patterns 📊";
            else if (streakDays === 1) encouragement = "1 day without a headache - great! 🎉";
            else if (streakDays < 5) encouragement = `${streakDays} days without a headache - keep it up! 🌟`;
            else encouragement = `Amazing! ${streakDays} days headache-free! 🎊`;
            
            const banner = document.getElementById('encouragementBanner');
            if (banner) banner.textContent = encouragement;

            generateCalendar(entries);
            generateInsights(entries);
            createCharts(entries);
        }

        function generateCalendar(entries) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            const entryMap = {};
            entries.forEach(e => entryMap[e.date] = e);

            let html = '<div class="calendar-grid">';
            
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });

            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div class="calendar-day no-data"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const entry = entryMap[dateStr];
                
                let className = 'calendar-day no-data';
                let content = day;
                
                if (entry) {
                    if (!entry.hasHeadache) {
                        className = 'calendar-day no-headache';
                        content = `${day}<br>✓`;
                    } else {
                        if (entry.intensity === '1-3') className = 'calendar-day headache-low';
                        else if (entry.intensity === '4-6') className = 'calendar-day headache-medium';
                        else className = 'calendar-day headache-high';
                        content = `${day}<br>⚠`;
                    }
                }
                
                html += `<div class="${className}">${content}</div>`;
            }
            
            html += '</div>';
            const calendarView = document.getElementById('calendarView');
            if (calendarView) calendarView.innerHTML = html;
        }

        function generateInsights(entries) {
            const container = document.getElementById('insightsContainer');
            if (!container) return;
            
            if (entries.length < 3) {
                container.innerHTML = '<div class="insight-card"><span class="insight-text">Keep tracking for a few more days to see patterns!</span></div>';
                return;
            }

            const headacheDays = entries.filter(e => e.hasHeadache);
            const noHeadacheDays = entries.filter(e => !e.hasHeadache);
            let insights = [];

            const headacheWithoutWater = headacheDays.filter(e => e.water && e.water.includes('❌')).length;
            const headacheWithWater = headacheDays.filter(e => e.water && e.water.includes('💧')).length;
            if (headacheWithoutWater > headacheWithWater) {
                insights.push({
                    icon: '💧',
                    text: `You had more headaches on days when you didn't drink enough water (${headacheWithoutWater} vs ${headacheWithWater} days)`
                });
            }

            const headacheWithExercise = headacheDays.filter(e => e.exercise === 'YES').length;
            const noHeadacheWithExercise = noHeadacheDays.filter(e => e.exercise === 'YES').length;
            if (noHeadacheWithExercise > headacheWithExercise && headacheDays.length > 0) {
                insights.push({ icon: '🏃', text: 'On days you exercised, you had fewer headaches' });
            }

            const headacheWithBadSleep = headacheDays.filter(e => e.sleep && e.sleep.includes('Not good')).length;
            if (headacheWithBadSleep > headacheDays.length / 2 && headacheDays.length > 2) {
                insights.push({ icon: '😴', text: 'Poor sleep seems connected to your headaches' });
            }

            if (headacheDays.length > 0) {
                const locations = {};
                headacheDays.forEach(e => {
                    if (e.location && e.location.length > 0) {
                        e.location.forEach(loc => locations[loc] = (locations[loc] || 0) + 1);
                    }
                });
                const mostCommonLocation = Object.keys(locations).reduce((a, b) => locations[a] > locations[b] ? a : b, '');
                if (mostCommonLocation) {
                    insights.push({
                        icon: '📍',
                        text: `Your headaches are usually in the ${mostCommonLocation.toLowerCase()} of your head`
                    });
                }

                const times = {};
                headacheDays.forEach(e => {
                    if (e.startTime) times[e.startTime] = (times[e.startTime] || 0) + 1;
                });
                const mostCommonTime = Object.keys(times).reduce((a, b) => times[a] > times[b] ? a : b, '');
                if (mostCommonTime) {
                    insights.push({
                        icon: '🕐',
                        text: `Most of your headaches happened in the ${mostCommonTime.toLowerCase()}`
                    });
                }
            }

            const headacheWithStress = headacheDays.filter(e => 
                e.mood && (e.mood.includes('😰 Worried/Stressed') || e.mood.includes('😠 Angry'))
            ).length;
            if (headacheWithStress > headacheDays.length / 2 && headacheDays.length > 2) {
                insights.push({
                    icon: '😰',
                    text: 'Your headaches were worse when you were worried, stressed, or angry'
                });
            }

            if (insights.length === 0) {
                container.innerHTML = '<div class="insight-card"><span class="insight-text">Keep tracking to discover your patterns! 📊</span></div>';
            } else {
                container.innerHTML = insights.map(insight => `
                    <div class="insight-card">
                        <span class="insight-icon">${insight.icon}</span>
                        <span class="insight-text">${insight.text}</span>
                    </div>
                `).join('');
            }
        }

        function createCharts(entries) {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayCounts = [0, 0, 0, 0, 0, 0, 0];
            
            entries.filter(e => e.hasHeadache).forEach(e => {
                const [year, month, day] = e.date.split('-');
                const date = new Date(year, month - 1, day);
                dayCounts[date.getDay()]++;
            });

            const ctx1 = document.getElementById('dayOfWeekChart');
            if (!ctx1) return;
            
            if (dayOfWeekChart) dayOfWeekChart.destroy();
            
            dayOfWeekChart = new Chart(ctx1.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: 'Number of Headaches',
                        data: dayCounts,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            const headacheDays = entries.filter(e => e.hasHeadache);
            const noHeadacheDays = entries.filter(e => !e.hasHeadache);

            const triggers = {
                'No Water': [
                    headacheDays.filter(e => e.water && e.water.includes('❌')).length,
                    noHeadacheDays.filter(e => e.water && e.water.includes('❌')).length
                ],
                'Poor Sleep': [
                    headacheDays.filter(e => e.sleep && e.sleep.includes('Not good')).length,
                    noHeadacheDays.filter(e => e.sleep && e.sleep.includes('Not good')).length
                ],
                'No Exercise': [
                    headacheDays.filter(e => e.exercise === 'NO').length,
                    noHeadacheDays.filter(e => e.exercise === 'NO').length
                ],
                'Stressed': [
                    headacheDays.filter(e => e.mood && e.mood.includes('😰 Worried/Stressed')).length,
                    noHeadacheDays.filter(e => e.mood && e.mood.includes('😰 Worried/Stressed')).length
                ]
            };

            const ctx2 = document.getElementById('triggerChart');
            if (!ctx2) return;
            
            if (triggerChart) triggerChart.destroy();

            triggerChart = new Chart(ctx2.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(triggers),
                    datasets: [{
                        label: 'Headache Days',
                        data: Object.values(triggers).map(t => t[0]),
                        backgroundColor: 'rgba(245, 87, 108, 0.7)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2
                    }, {
                        label: 'No Headache Days',
                        data: Object.values(triggers).map(t => t[1]),
                        backgroundColor: 'rgba(79, 172, 254, 0.7)',
                        borderColor: 'rgba(79, 172, 254, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function generateDoctorReport() {
            const entries = JSON.parse(localStorage.getItem(getUserStorageKey()) || '[]');
            
            if (entries.length === 0) {
                alert('Please log some entries before generating a report.');
                return;
            }

            entries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const [startYear, startMonth, startDay] = entries[0].date.split('-');
            const startDate = new Date(startYear, startMonth - 1, startDay);
            const startDateFormatted = startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            const [endYear, endMonth, endDay] = entries[entries.length - 1].date.split('-');
            const endDate = new Date(endYear, endMonth - 1, endDay);
            const endDateFormatted = endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

            const headacheDays = entries.filter(e => e.hasHeadache);
            const totalHeadaches = headacheDays.length;

            let totalIntensity = 0;
            headacheDays.forEach(e => {
                if (e.intensity === '1-3') totalIntensity += 2;
                else if (e.intensity === '4-6') totalIntensity += 5;
                else if (e.intensity === '7-9') totalIntensity += 8;
                else if (e.intensity === '10') totalIntensity += 10;
            });
            const avgIntensity = headacheDays.length > 0 ? (totalIntensity / headacheDays.length).toFixed(1) : 0;

            const locations = {};
            headacheDays.forEach(e => {
                if (e.location && e.location.length > 0) {
                    e.location.forEach(loc => locations[loc] = (locations[loc] || 0) + 1);
                }
            });
            const mostCommonLocation = Object.keys(locations).length > 0 
                ? Object.keys(locations).reduce((a, b) => locations[a] > locations[b] ? a : b)
                : 'Not specified';

            const durations = {};
            headacheDays.forEach(e => {
                if (e.duration) durations[e.duration] = (durations[e.duration] || 0) + 1;
            });
            const mostCommonDuration = Object.keys(durations).length > 0
                ? Object.keys(durations).reduce((a, b) => durations[a] > durations[b] ? a : b)
                : 'Not specified';

            const triggers = [];
            const headacheWithoutWater = headacheDays.filter(e => e.water && e.water.includes('❌')).length;
            if (headacheWithoutWater > totalHeadaches / 2) triggers.push('Inadequate water intake');
            
            const headacheWithBadSleep = headacheDays.filter(e => e.sleep && e.sleep.includes('Not good')).length;
            if (headacheWithBadSleep > totalHeadaches / 2) triggers.push('Poor sleep quality');
            
            const headacheWithStress = headacheDays.filter(e => 
                e.mood && (e.mood.includes('😰 Worried/Stressed') || e.mood.includes('😠 Angry'))
            ).length;
            if (headacheWithStress > totalHeadaches / 2) triggers.push('Stress and emotional distress');

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Headache Tracking Report - ${currentUser}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            max-width: 800px;
                            margin: 40px auto;
                            padding: 20px;
                            line-height: 1.6;
                        }
                        h1 {
                            color: #667eea;
                            border-bottom: 3px solid #667eea;
                            padding-bottom: 10px;
                        }
                        h2 {
                            color: #764ba2;
                            margin-top: 30px;
                        }
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 20px;
                            margin: 20px 0;
                        }
                        .summary-item {
                            background: #f0f0f0;
                            padding: 15px;
                            border-radius: 8px;
                        }
                        .summary-label {
                            font-weight: bold;
                            color: #667eea;
                        }
                        .entry-list {
                            margin: 20px 0;
                        }
                        .entry-item {
                            background: #f9f9f9;
                            padding: 15px;
                            margin: 10px 0;
                            border-left: 4px solid #667eea;
                            border-radius: 4px;
                        }
                        .no-print {
                            text-align: center;
                            margin: 30px 0;
                        }
                        .print-button {
                            padding: 15px 30px;
                            font-size: 16px;
                            background: #667eea;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>📋 Headache Tracking Report - ${currentUser}</h1>
                    
                    <p><strong>Tracking Period:</strong> ${startDateFormatted} to ${endDateFormatted}</p>
                    <p><strong>Total Days Tracked:</strong> ${entries.length}</p>
                    
                    <h2>Summary Statistics</h2>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Headaches</div>
                            <div>${totalHeadaches}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Average Intensity</div>
                            <div>${avgIntensity} out of 10</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Most Common Location</div>
                            <div>${mostCommonLocation}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Typical Duration</div>
                            <div>${mostCommonDuration}</div>
                        </div>
                    </div>

                    <h2>Identified Trigger Patterns</h2>
                    ${triggers.length > 0 
                        ? '<ul>' + triggers.map(t => `<li>${t}</li>`).join('') + '</ul>'
                        : '<p>No clear trigger patterns identified yet. Continue tracking for more insights.</p>'
                    }

                    <h2>Detailed Entry Log</h2>
                    <div class="entry-list">
                        ${headacheDays.slice(0, 20).map(entry => {
                            const [year, month, day] = entry.date.split('-');
                            const date = new Date(year, month - 1, day);
                            const formattedDate = date.toLocaleDateString('en-US', { 
                                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                            });
                            return `
                                <div class="entry-item">
                                    <strong>${formattedDate}</strong><br>
                                    <strong>Intensity:</strong> ${entry.intensity}/10<br>
                                    <strong>Location:</strong> ${entry.location.join(', ')}<br>
                                    <strong>Duration:</strong> ${entry.duration}<br>
                                    <strong>Started:</strong> ${entry.startTime}<br>
                                    ${entry.symptoms && entry.symptoms.length > 0 
                                        ? `<strong>Symptoms:</strong> ${entry.symptoms.join(', ')}<br>` : ''
                                    }
                                    <strong>Water Intake:</strong> ${entry.water}<br>
                                    <strong>Sleep Quality:</strong> ${entry.sleep}<br>
                                    <strong>Exercise:</strong> ${entry.exercise}
                                </div>
                            `;
                        }).join('')}
                        ${headacheDays.length > 20 ? `<p><em>Showing most recent 20 headache entries out of ${headacheDays.length} total.</em></p>` : ''}
                    </div>

                    <div class="no-print">
                        <button class="print-button" onclick="window.print()">Print Report</button>
                    </div>

                    <p style="margin-top: 40px; font-size: 0.9em; color: #666;">
                        <em>This report is generated from patient-tracked data and should be reviewed by a qualified healthcare provider. 
                        It is not a substitute for professional medical diagnosis or treatment.</em>
                    </p>
                </body>
                </html>
            `);
            reportWindow.document.close();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        function init() {
            displayCurrentDate();
            checkForCurrentUser();
        }
    </script>
</body>
</html>
